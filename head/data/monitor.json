# Monitor template 
#
#

{
  "_id"  : "monitor",
  "type" : "control_template",
  "header" : "
<style> type='text/css'>
    #monitor_div {
    position: absolute;
    left: 20px;
    right: 20px;
    top: 40px;
    bottom: 100px;
    }
    </style>
",
  "body" : "   

<div data-role='page' id='db_monitor_{{db_name}}'>
    <div class='headerChild'> 
    </div>

    <!--<div class='headerKid'>
    </div>
    <script>$('headerKid').load('./index.html #standardHeader');</script> -->
    <div align='center' data-role='content' id='contentConfirmation' name='contentConfirmation'>
        <div class='content-primary'>
            <h1 >Monitor</h1>
            <div data-role='controlgroup' data-type='horizontal'>
                <a href='#' data-role='button' data-inline='true' id='makeNewPlot_{{db_name}}'>Insert New Graph</a>
                <select name='selectCurrentPlot' id='selectCurrentPlot_{{db_name}}' class = 'ui-disabled'>
                </select>
                <a href='#' data-role='button' data-inline='true' id='removePlot_{{db_name}}' class='ui-disabled'>Remove Selected</a>
            </div>
            <div data-role='controlgroup' data-type='horizontal'>
                <a href='#' data-role='button' data-inline='true' id='addSlowControl_{{db_name}}' class = 'ui-disabled'>Add to selected graph</a>
                <select name='selectSlowControl' id='selectSlowControl_{{db_name}}' class = 'ui-disabled'>
                </select>
            </div>

            <div id='monitor_div_{{db_name}}'>
            
            </div>
        </div> <!-- content-primary -->
        <div class='content-secondary'>
            <div data-role='collapsible-set' class='listofdbs' data-inset='false'> 
            </div>
        </div> <!-- content-secondary -->
        <script type='text/javascript'>
            var makeNewGraph = function() {
            var new_name = Math.random().toString(36).substr(2,9);
            var new_div = $('<div></div>');
            new_div.addClass('monitor_class');
            new_div.attr('id', 'div_' + new_name);

            var selection = $('#selectCurrentPlot_{{db_name}}');
            var anum = selection.find('option').length;
            new_div.append('<p>Window ' + anum + '</p>');
            var plot_div = $('<div></div>');
            new_div.append(plot_div);
            var now = new Date(Date.now() - 600000);
            var now2 = new Date(now);
            var legend_div = $('<div/>')
                   .attr('data-role', 'fieldcontain')
                   .append($('<fieldset/>').attr({'data-role' : 'controlgroup', 'data-type' : 'horizontal'})
                           .append('<legend>Plotted variables:</legend>')
                           .append($('<a/>').attr({href : '#', 
                                                   'data-role' : 'button', 
                                                   'data-inline' : 'true', 
                                                   id : 'remove_plotted_' + new_name, 
                                                   class : 'ui-disabled'}).append('Remove'))
                           .append($('<select/>').attr({ name : 'plotted_' + new_name, 
                                                           id : 'plotted_' + new_name}))
                          );
            var gimme_datebox = function(atype, anid) {
                 var opts = { mode : atype,
                              lockInput : false,
                              showInitialValue : true,
                              useNewStyle : true }; 
                 return $('<input>').attr({ type : 'text',
                                            'data-role' : 'datebox',
                                            id : anid,
                                            'data-options' : JSON.stringify(opts)});
            };
            var date_div = $('<div/>').attr('data-role', 'collapsible')
                   .append('<h4>Advanced Options</h4>')
                   .append($('<div/>').attr({ class : 'ui-grid-b'})
                                      .append($('<div/>').attr( { class : 'ui-block-a' })
                                                         .append('<h5>Start:</h5>')
                                                         .append('<h5>End:</h5>')
                                             )
                                      .append($('<div/>').attr( { class : 'ui-block-b' })
                                                         .append(gimme_datebox('calbox', 'date_' + new_name))
                                                         .append(gimme_datebox('calbox', 'dateend_' + new_name))
                                             )
                                      .append($('<div/>').attr( { class : 'ui-block-c' })
                                                         .append(gimme_datebox('timeflipbox', 'time_' + new_name))
                                                         .append(gimme_datebox('timeflipbox', 'timeend_' + new_name))
                                               )
                          )
                   .append($('<div/>')
                           .attr('data-role', 'fieldcontain')
                           .append($('<fieldset/>')
                                   .attr({'data-role' : 'controlgroup', 'data-type' : 'horizontal'})
                                   .append($('<label/>').append($('<input>').attr(
                                                                                  { type : 'checkbox',
                                                                                      id : 'checkboxuntilnow_' + new_name,
                                                                                   class : 'custom'})
                                                                )
                                                        .append('Live')
                                          )
                                   .append($('<select/>').attr({ class : 'averaging_select' }))
                                   .append($('<button/>').attr({ class : 'ui-btn ui-corner-all date_button_execute', id : 'datebutton_' + new_name})
                                                         .append('Set times')
                                           )
                                  )
                          ).append($('<div/>').attr({'class' : 'variable_progress'}));

            var avg_select = date_div.find('.averaging_select');
            $.each({
              'Avg: None'  : 10,
                  'Minutes': 6,
                  'Hours'  : 5,
                  'Days'   : 4,
                  'Months' : 3,
                  'Years'  : 2,
                  'All'    : 1,
            }, function(t, v) {
                avg_select.append($('<option/>').val(v).html(t));
            });

            new_div.append(legend_div);
            new_div.append(date_div);

            selection.append($('<option/>').attr( { value : new_name } ).append('Window ' + anum));
            selection[0].selectedIndex = anum;
            $('#monitor_div_{{db_name}}').append(new_div);
            new_div.trigger('create');

            $('#time_' + new_name).datebox('setTheDate',now);
            $('#time_' + new_name).trigger('datebox', 
              { method: 'set',
                value:  $('#time_' + new_name).datebox('callFormat', '%H:%M', now)});
            now2.setHours(0);
            now2.setMinutes(0);
            $('#date_' + new_name).datebox('setTheDate',now2);

            $('#removePlot_{{db_name}}').removeClass('ui-disabled');
            selection.removeClass('ui-disabled');
            $('#selectSlowControl_{{db_name}}').removeClass('ui-disabled');
            if ($('#selectSlowControl_{{db_name}}').find('option').length !== 0) {
                $('#addSlowControl_{{db_name}}').removeClass('ui-disabled');
            }
            selection.selectmenu('refresh', true);


            var obj = new nedm.MonitoringGraph(plot_div[0], [], now, nedm.get_database()); 
            new_div.data('graph', obj);

            obj.beginListening();
            var ensure_until_now_state = function() {
                var until_now = $('#checkboxuntilnow_' + new_name).is(':checked');
                if ( until_now ) {
                  $('#dateend_' + new_name).addClass('ui-disabled');
                  $('#timeend_' + new_name).addClass('ui-disabled');
                } else {
                  $('#dateend_' + new_name).removeClass('ui-disabled');
                  $('#timeend_' + new_name).removeClass('ui-disabled');
                }
                return until_now;
            };
            var get_new_progress = function (aname) {
                var retDiv = $('<div/>')
                    .attr('data-role', 'fieldcontain')
                    .append(
                $('<fieldset/>')
                    .attr({
                    'data-role': 'controlgroup',
                        'data-type': 'horizontal'
                })
                    .append($('<a/>')
                    .attr({
                    'data-role': 'button',
                        'data-icon': 'nedm-loading',
                        'data-iconpos': 'right',
                        'class': 'cancel_button'
                })
                    .append('Cancel '))
                    .append($('<a/>').attr({
                    'data-role': 'button',
                        'class': 'ui-disabled loading_view'
                })
                    .append(aname + ' loading: '))
                    .data({
                    varname: aname
                }));
                retDiv.data({
                    varname: aname,
                    should_cancel: false
                });
                retDiv.find('.cancel_button').on('click',
            
                function () {
                    $(this).addClass('ui-disabled');
                    retDiv.data({
                        should_cancel: true
                    });
                });
                return retDiv;
            };
            var change_dates = function(eve) {
                var get_new_date = function(prefix) {
                    var the_date = $('#date' + prefix + '_' + new_name).datebox('getTheDate');
                    var the_time = $('#time' + prefix + '_' + new_name).datebox('getTheDate');
                    the_date.setHours( the_time.getHours() );
                    the_date.setMinutes( the_time.getMinutes() );
                    the_date.setSeconds( the_time.getSeconds() );
                    return the_date;
                };
                var start_date = get_new_date(''); 
                var end_date = get_new_date('end'); 
                var until_now = ensure_until_now_state();
                if (until_now) end_date = 0;
                var current_progress = date_div.find('.variable_progress');
                for (var j=0;j<obj.name.length;j++) {
                    current_progress.append(get_new_progress(obj.name[j]));
                }
                current_progress.trigger('create');
                var update_function = function (objs) {
                    var retVal = true;
                    current_progress.find('[data-role=fieldcontain]').each(function () {
                        var o = $(this).data();
                        var isDone = (!objs || objs.done);
                        if (isDone || o.should_cancel) {
                            retVal = false;
                            $(this).remove();
                            return true;
                        }
                        if (o.varname != objs.variable) return;
                        $(this).find('.loading_view')
                        .text(o.varname + ' loaded: ' + 
                              objs.loaded.toString());
                        return false;
                    });
                    return retVal;
                };

                obj.changeTimeRange(start_date, end_date, update_function);
            };

            avg_select.on('change', function() {
              obj.setGroupLevel($(this).val());
            });
            $('#db_monitor_{{db_name}}').on('pagebeforeshow', function(o) { return function() { o.beginListening(); }; }(obj));
            $('#datebutton_' + new_name).on('click', change_dates);
            $('#checkboxuntilnow_' + new_name).checkboxradio('refresh');
            $('#checkboxuntilnow_' + new_name).on('change', function() { 
                ensure_until_now_state(); 
                $('#datebutton_' + new_name).trigger('click'); 
            });
            $('#remove_plotted_' + new_name).on('click', function() {
              var ssc = $('#plotted_' + new_name).find(':selected');
              obj.removeDataName(ssc.val(), function() {
                ssc.remove(); 
                var plt = $('#plotted_' + new_name);
                if (plt.find('option').length === 0) {  
                  $('#remove_plotted_' + new_name).addClass('ui-disabled');
                }
                plt.selectmenu('refresh', true);
              });
            });
            $('#checkboxuntilnow_' + new_name).trigger('click'); 
        };

        var destroyGraph = function() {
            var scp = $('#selectCurrentPlot_{{db_name}}');
            var selected = scp.find(':selected'); 
            var sIndex = scp[0].selectedIndex;

            // remove the div
            $('#div_' + selected.val()).remove();

            // Now update the select menu
            selected.remove();
            if (sIndex != 0) sIndex--;
            scp[0].selectedIndex = sIndex;


            if (scp.find('option').length === 0) {
              // disable button if nothing is there
              $('#removePlot_{{db_name}}').addClass('ui-disabled');
              $('#selectSlowControl_{{db_name}}').addClass('ui-disabled');
              $('#addSlowControl_{{db_name}}').addClass('ui-disabled');

            }
            scp.selectmenu('refresh', true);
        };

        var getAvailableItems = function () {
            // We can have stale = update_after since the data types will not change all that often.
            nedm.get_database().getView('slow_control_time', 'slow_control_time', 
                { opts : {stale : 'update_after', group_level : 1} }, function (e, o) {
                        if (e !== null ) return;
                        var ssc = $('#selectSlowControl_{{db_name}}');
                        for (var i=0;i<o.rows.length;i++) {
                            var aname = o.rows[i].key;
                            ssc.append($('<option/>').attr({value : aname}).append(aname));
                        }
                        if (ssc.find('option').length !== 0) {
                            ssc.removeClass('ui-disabled');
                            if ($('#selectCurrentPlot_{{db_name}}').find('option').length !== 0) {
                                $('#addSlowControl_{{db_name}}').removeClass('ui-disabled');
                            }
                        }
                        ssc.selectmenu('refresh', true);
                    }); 

        };

        var exitCleanup = function () {
            if($('.monitor_class').length) { $('.monitor_class').data('graph').endListening(); } 
        };

        var addSelectedPlotToWindow = function() {
            var scp = $('#selectCurrentPlot_{{db_name}}');
            var selected = scp.find(':selected'); 
            var obj = $('#div_' + selected.val()).data('graph');
            var ssc = $('#selectSlowControl_{{db_name}}').find(':selected');
            if (!obj.addDataName(ssc.val())) return; 
            $('#div_' + selected.val()).find('.date_button_execute').trigger('click');

            if ( $('#plotted_' + selected.val() + ' option[value=' + ssc.val() + ']').length >= 1 ) return;
            var plotted_vars = $('#plotted_' + selected.val());
            plotted_vars.append($('<option/>').attr({value : ssc.val()}).append(ssc.val()));
            plotted_vars.selectmenu('refresh', true);
            $('#remove_plotted_' + selected.val()).removeClass('ui-disabled');
        };

        $('#makeNewPlot_{{db_name}}').off('click').on('click', makeNewGraph );
        $('#removePlot_{{db_name}}').off('click').on('click', destroyGraph );
        $('#addSlowControl_{{db_name}}').off('click').on('click', addSelectedPlotToWindow );
        $('#db_monitor_{{db_name}}').on('pagebeforeshow', getAvailableItems);
        $('#db_monitor_{{db_name}}').on('pagehide', exitCleanup);

	    </script>
    </div>
</div>
"
}
